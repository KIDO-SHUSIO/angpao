<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&amp;family=Ma+Shan+Zheng&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans Thai', sans-serif; }
    .chinese-text { font-family: 'Ma Shan Zheng', cursive; }
    
    .envelope {
      position: relative;
      width: 280px;
      height: 400px;
      transform-style: preserve-3d;
      perspective: 1000px;
    }
    
    .envelope-front {
      position: absolute;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #dc2626 0%, #b91c1c 50%, #991b1b 100%);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s ease;
      border: 3px solid #fbbf24;
    }
    
    .envelope-front:hover {
      transform: scale(1.02);
    }
    
    .envelope-flap {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 120px;
      background: linear-gradient(180deg, #b91c1c 0%, #991b1b 100%);
      border-radius: 12px 12px 0 0;
      transform-origin: top center;
      transition: transform 0.6s ease;
      z-index: 10;
      border: 3px solid #fbbf24;
      border-bottom: none;
    }
    
    .envelope-flap::after {
      content: '';
      position: absolute;
      bottom: -60px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 137px solid transparent;
      border-right: 137px solid transparent;
      border-top: 60px solid #991b1b;
    }
    
    .envelope.opened .envelope-flap {
      transform: rotateX(-180deg);
    }
    
    .gold-circle {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(251, 191, 36, 0.5);
      z-index: 5;
      font-size: 56px;
      line-height: 1;
      transition: opacity 0.6s ease;
    }
    
    .envelope.opened .gold-circle {
      opacity: 0;
      pointer-events: none;
    }
    
    .content-reveal {
      position: absolute;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.6s ease 0.3s;
      z-index: 1;
    }
    
    .envelope.opened .content-reveal {
      opacity: 1;
    }
    
    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #fbbf24;
      border-radius: 50%;
      animation: sparkle 1.5s ease-in-out infinite;
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes coinDrop {
      0% { transform: translateY(-50px) rotate(0deg); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateY(0) rotate(360deg); opacity: 1; }
    }
    
    .coin-animation {
      animation: coinDrop 0.8s ease-out forwards;
    }
    
    .coin-emoji {
      font-size: 60px;
      line-height: 1;
      display: block;
    }
    
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-unopened {
      background-color: #fef08a;
      color: #854d0e;
    }
    
    .status-opened {
      background-color: #86efac;
      color: #166534;
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration for tester-a903d
    const firebaseConfig = {
      apiKey: "AIzaSyDPYgwPG7sM6N_fPXQxvbXskIHdJepD9WM",
      authDomain: "tester-a903d.firebaseapp.com",
      databaseURL: "https://tester-a903d-default-rtdb.firebaseio.com/",
      projectId: "tester-a903d",
      storageBucket: "tester-a903d.firebasestorage.app",
      messagingSenderId: "939339329194",
      appId: "1:939339329194:web:154a87fcf564c665d2aad3",
      measurementId: "G-WY59XWJ280"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

</head>
 <body class="h-full bg-gradient-to-br from-red-900 via-red-800 to-red-900 overflow-auto">
  <div id="app" class="min-h-full w-full flex items-center justify-center p-4"><!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏á + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏≠‡∏á) -->
   <div id="sender-page" class="w-full max-w-2xl"><!-- Tab Navigation -->
    <div class="flex gap-2 mb-6"><button onclick="switchTab('create')" class="create-tab px-6 py-3 bg-white/95 rounded-lg font-semibold text-red-700 border-b-4 border-red-700 transition-all">üßß ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏á</button> <button onclick="switchTab('history')" class="history-tab px-6 py-3 bg-white/20 rounded-lg font-semibold text-red-200 border-b-4 border-transparent transition-all">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡∏≠‡∏á</button>
    </div><!-- Create Tab -->
    <div id="create-tab" class="bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-8 border-4 border-yellow-400">
     <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-red-500 to-red-700 rounded-full mb-4 shadow-lg"><span class="text-4xl">üßß</span>
      </div>
      <h1 class="text-3xl font-bold text-red-700 chinese-text">ÊÅ≠ÂñúÁôºË≤°</h1>
      <p class="text-gray-600 mt-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</p>
     </div>
     <div class="space-y-6">
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label> <input type="number" id="amount-input" placeholder="888" min="1" class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all text-lg font-semibold text-center">
       <div class="flex gap-2 mt-2"><button onclick="setAmount(88)" class="flex-1 py-2 bg-yellow-100 hover:bg-yellow-200 rounded-lg text-sm font-medium text-yellow-800">‡∏ø88</button> <button onclick="setAmount(168)" class="flex-1 py-2 bg-yellow-100 hover:bg-yellow-200 rounded-lg text-sm font-medium text-yellow-800">‡∏ø168</button> <button onclick="setAmount(888)" class="flex-1 py-2 bg-yellow-100 hover:bg-yellow-200 rounded-lg text-sm font-medium text-yellow-800">‡∏ø888</button> <button onclick="setAmount(1888)" class="flex-1 py-2 bg-yellow-100 hover:bg-yellow-200 rounded-lg text-sm font-medium text-yellow-800">‡∏ø1888</button>
       </div>
      </div>
      <div><label class="block text-sm font-semibold text-gray-700 mb-2">‚ú® ‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£</label> <textarea id="message-input" rows="3" placeholder="‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏ï‡∏£‡∏∏‡∏©‡∏à‡∏µ‡∏ô ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢‡πÜ" class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-500 focus:ring-4 focus:ring-red-100 transition-all resize-none"></textarea>
       <div class="flex flex-wrap gap-2 mt-2"><button onclick="setMessage('ÊÅ≠ÂñúÁôºË≤° ‡∏£‡πà‡∏≥‡∏£‡∏ß‡∏¢‡πÜ')" class="px-3 py-1 bg-red-100 hover:bg-red-200 rounded-full text-xs font-medium text-red-700">üéä ÊÅ≠ÂñúÁôºË≤°</button> <button onclick="setMessage('Ëê¨‰∫ãÂ¶ÇÊÑè ‡∏™‡∏°‡∏õ‡∏£‡∏≤‡∏£‡∏ñ‡∏ô‡∏≤')" class="px-3 py-1 bg-red-100 hover:bg-red-200 rounded-full text-xs font-medium text-red-700">üåü Ëê¨‰∫ãÂ¶ÇÊÑè</button> <button onclick="setMessage('Êñ∞Âπ¥Âø´Ê®Ç ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà')" class="px-3 py-1 bg-red-100 hover:bg-red-200 rounded-full text-xs font-medium text-red-700">üéÜ Êñ∞Âπ¥Âø´Ê®Ç</button>
       </div>
      </div><button id="create-btn" onclick="createEnvelope()" class="w-full py-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-[1.02] active:scale-[0.98]"> üßß ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤ </button>
      <div id="link-section" class="hidden">
       <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl p-4">
        <p class="text-sm font-semibold text-green-700 mb-2">‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</p>
        <div class="flex gap-2"><input type="text" id="share-link" readonly class="flex-1 px-3 py-2 bg-white border border-green-300 rounded-lg text-sm text-gray-700"> <button onclick="copyLink()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-all"> üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å </button>
        </div>
        <p id="copy-success" class="hidden text-green-600 text-sm mt-2 font-medium">‚úì ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß!</p>
       </div>
      </div>
     </div>
    </div><!-- History Tab -->
    <div id="history-tab" class="hidden bg-white/95 backdrop-blur rounded-3xl shadow-2xl p-8 border-4 border-yellow-400">
     <h2 class="text-2xl font-bold text-red-700 mb-6">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤</h2>
     <div id="envelopes-list" class="space-y-3">
      <p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ã‡∏≠‡∏á ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
     </div>
    </div>
   </div><!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡∏≠‡∏á) -->
   <div id="receiver-page" class="hidden w-full flex flex-col items-center justify-center py-8">
    <div class="text-center mb-12">
     <h2 class="text-2xl font-bold text-yellow-300 chinese-text mb-2">ÊÅ≠ÂñúÁôºË≤°</h2>
     <p class="text-red-200 text-sm">‡πÅ‡∏ï‡∏∞‡∏ã‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏Ñ</p>
    </div>
    <div class="envelope float-animation" id="envelope" onclick="openEnvelope()" role="button" tabindex="0" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤">
     <div class="envelope-flap"></div>
     <div class="envelope-front">
      <div class="gold-circle"><span class="chinese-text text-red-800">Á¶è</span>
      </div>
      <p class="text-yellow-300 font-bold text-lg mt-4 chinese-text">ÊÅ≠ÂñúÁôºË≤°</p>
      <p class="text-yellow-200 text-sm mt-1">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î</p>
      <div class="sparkle" style="top: 20%; left: 10%; animation-delay: 0s;"></div>
      <div class="sparkle" style="top: 30%; right: 15%; animation-delay: 0.3s;"></div>
      <div class="sparkle" style="bottom: 25%; left: 20%; animation-delay: 0.6s;"></div>
      <div class="sparkle" style="bottom: 35%; right: 10%; animation-delay: 0.9s;"></div>
     </div>
     <div class="content-reveal">
      <div class="mb-4">
       <div class="w-24 h-24 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center shadow-lg coin-animation"><span class="coin-emoji">üí∞</span>
       </div>
      </div>
      <p class="text-red-700 text-lg font-medium mb-2">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</p>
      <p id="reveal-amount" class="text-4xl font-bold text-red-800 mb-4">‡∏ø888</p>
      <div class="bg-red-100 rounded-xl px-4 py-3 max-w-full">
       <p id="reveal-message" class="text-red-700 text-center text-sm">‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏ï‡∏£‡∏∏‡∏©‡∏à‡∏µ‡∏ô!</p>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    let envelopes = [];
    let currentEnvelopeId = null;

    // initialize Firebase listener
    function initFirebase() {
      const ref = db.ref('envelopes');
      ref.orderByChild('created_at').on('value', snapshot => {
        envelopes = [];
        snapshot.forEach(child => {
          envelopes.push(child.val());
        });
        // sort descending in case orderByChild doesn't behave as expected
        envelopes.sort((a, b) => b.created_at.localeCompare(a.created_at));
        renderEnvelopesList();
      }, err => {
        console.error('Realtime listener error', err);
        const linkSection = document.getElementById('link-section');
        if (linkSection) {
          linkSection.classList.remove('hidden');
          linkSection.innerHTML = '<div class="bg-red-50 border-2 border-red-300 rounded-xl p-4"><p class="text-red-700 font-medium">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤</p></div>';
        }
      });
    }

    initFirebase();

    function setAmount(amount) {
      document.getElementById('amount-input').value = amount;
    }

    function setMessage(message) {
      document.getElementById('message-input').value = message;
    }

    function switchTab(tab) {
      const createTab = document.getElementById('create-tab');
      const historyTab = document.getElementById('history-tab');
      const createTabBtn = document.querySelector('.create-tab');
      const historyTabBtn = document.querySelector('.history-tab');
      
      if (tab === 'create') {
        createTab.classList.remove('hidden');
        historyTab.classList.add('hidden');
        createTabBtn.classList.add('bg-white/95', 'text-red-700', 'border-red-700');
        createTabBtn.classList.remove('bg-white/20', 'text-red-200', 'border-transparent');
        historyTabBtn.classList.remove('bg-white/95', 'text-red-700', 'border-red-700');
        historyTabBtn.classList.add('bg-white/20', 'text-red-200', 'border-transparent');
      } else {
        createTab.classList.add('hidden');
        historyTab.classList.remove('hidden');
        historyTabBtn.classList.add('bg-white/95', 'text-red-700', 'border-red-700');
        historyTabBtn.classList.remove('bg-white/20', 'text-red-200', 'border-transparent');
        createTabBtn.classList.remove('bg-white/95', 'text-red-700', 'border-red-700');
        createTabBtn.classList.add('bg-white/20', 'text-red-200', 'border-transparent');
      }
    }

    async function createEnvelope() {
      let rawAmount = document.getElementById('amount-input').value;
      // remove commas or other non‚Äënumeric characters except dot
      rawAmount = rawAmount.replace(/[^0-9.]/g, '');
      const amount = parseFloat(rawAmount);
      const message = document.getElementById('message-input').value.trim();

      // client-side validation
      if (!amount || amount <= 0) {
        const linkSection = document.getElementById('link-section');
        linkSection.classList.remove('hidden');
        linkSection.innerHTML = '<div class="bg-red-50 border-2 border-red-300 rounded-xl p-4"><p class="text-red-700 font-medium">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p></div>';
        setTimeout(() => linkSection.classList.add('hidden'), 2000);
        return;
      }


      const envelopeId = 'env_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

      try {
        await db.ref('envelopes/' + envelopeId).set({
          envelope_id: envelopeId,
          amount: amount,
          message: message || '‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏ï‡∏£‡∏∏‡∏©‡∏à‡∏µ‡∏ô',
          created_at: new Date().toISOString(),
          opened_at: '',
          is_opened: false
        });
      } catch (err) {
        console.error('Realtime create failed', err);
        const linkSection = document.getElementById('link-section');
        linkSection.classList.remove('hidden');
        linkSection.innerHTML = '<div class="bg-red-50 border-2 border-red-300 rounded-xl p-4"><p class="text-red-700 font-medium">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p></div>';
        setTimeout(() => linkSection.classList.add('hidden'), 4000);
        return;
      }

      const baseUrl = window.location.origin + window.location.pathname;
      const params = new URLSearchParams();
      params.set('open', 'yes');
      params.set('id', envelopeId);
      params.set('amount', amount.toString());
      params.set('message', message || '‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏ï‡∏£‡∏∏‡∏©‡∏à‡∏µ‡∏ô');
      const shareLink = `${baseUrl}?${params.toString()}`;

      document.getElementById('share-link').value = shareLink;
      document.getElementById('link-section').classList.remove('hidden');
      document.getElementById('copy-success').classList.add('hidden');

      // Clear inputs
      document.getElementById('amount-input').value = '';
      document.getElementById('message-input').value = '';

      // Switch to history tab
      setTimeout(() => switchTab('history'), 1000);
    }

    function copyLink() {
      const linkInput = document.getElementById('share-link');
      const text = linkInput.value;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          document.getElementById('copy-success').classList.remove('hidden');
        }).catch(err => {
          console.error('Clipboard API failed, falling back', err);
          linkInput.select();
          document.execCommand('copy');
          document.getElementById('copy-success').classList.remove('hidden');
        });
      } else {
        linkInput.select();
        document.execCommand('copy');
        document.getElementById('copy-success').classList.remove('hidden');
      }
    }

    function renderEnvelopesList() {
      const list = document.getElementById('envelopes-list');
      
      if (envelopes.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ã‡∏≠‡∏á ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>';
        return;
      }
      
      list.innerHTML = envelopes.map(env => {
        const createdDate = new Date(env.created_at).toLocaleString('th-TH');
        const openedDate = env.is_opened ? new Date(env.opened_at).toLocaleString('th-TH') : '-';
        
        return `
          <div class="border-2 border-red-200 rounded-lg p-4 flex justify-between items-center">
            <div class="flex-1">
              <p class="font-semibold text-red-700">‡∏ø${env.amount.toLocaleString()}</p>
              <p class="text-sm text-gray-600 mt-1">${env.message}</p>
              <p class="text-xs text-gray-500 mt-2">‡∏™‡∏£‡πâ‡∏≤‡∏á: ${createdDate}</p>
              ${env.is_opened ? `<p class="text-xs text-green-600 mt-1">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${openedDate}</p>` : ''}
            </div>
            <div class="text-right">
              <span class="status-badge ${env.is_opened ? 'status-opened' : 'status-unopened'}">
                ${env.is_opened ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß' : 'üì¨ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î'}
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    async function openEnvelope() {
      const envelopeEl = document.getElementById('envelope');
      envelopeEl.classList.add('opened');
      
      // Mark envelope as opened
      if (currentEnvelopeId) {
        try {
          await db.ref('envelopes/' + currentEnvelopeId).update({
            is_opened: true,
            opened_at: new Date().toISOString()
          });
        } catch (err) {
          console.error('Failed to mark envelope opened', err);
        }
      }
    }

    function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const isOpen = urlParams.get('open');
      const id = urlParams.get('id');
      const amount = urlParams.get('amount');
      // decode message explicitly since we encoded earlier
      let message = urlParams.get('message');
      if (message) {
        try {
          message = decodeURIComponent(message);
        } catch (_) { /* ignore invalid */ }
      }
      
      if (isOpen === 'yes' && id) {
        currentEnvelopeId = id;
        document.getElementById('sender-page').classList.add('hidden');
        document.getElementById('receiver-page').classList.remove('hidden');
        
        document.getElementById('reveal-amount').textContent = `‡∏ø${parseFloat(amount).toLocaleString()}`;
        document.getElementById('reveal-message').textContent = message || '‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏ï‡∏£‡∏∏‡∏©‡∏à‡∏µ‡∏ô!';
      }

      // accessibility: allow keyboard users to open
      const envelopeEl = document.getElementById('envelope');
      if (envelopeEl) {
        envelopeEl.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openEnvelope();
          }
        });
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cecf810f0f67b54',t:'MTc3MTI0NDExMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>